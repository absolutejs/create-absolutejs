# Cloud & Auth Test Verification Guide

This guide documents how we validate cloud integrations and AbsoluteAuth across supported matrices, how to interpret skips, and how to run the verification locally or in CI.

## Goals
- Ensure Neon and Turso functional tests pass for supported combinations.
- Ensure unsupported combinations are intentionally skipped with clear reasons (PlanetScale, MongoDB+AbsoluteAuth, etc.).
- Validate behavioural endpoints for AbsoluteAuth (`/auth/providers`, `/auth/session`) are present and respond.
- Provide reproducible commands, reporting locations, and cleanup guidance.

## Key files
- Matrix generator: `scripts/functional-tests/matrix.ts`
- Functional harness registry: `scripts/functional-tests/test-cli-registry.ts`
- Functional CLI runner: `scripts/functional-tests/test-cli.ts`
- Functional framework test utils: `tests/functional/frameworks/test-utils.ts`
- Behavioural auth tests: `tests/behavioural/auth-matrix.test.ts`
- Cleanup script: `scripts/clean-tests.sh` (invoked by `npm run test:clean`)

## How the matrix works
- Run `node scripts/functional-tests/matrix.ts` to generate permutations (the script now annotates unsupported combos with `skip` and `skipReason`).
- The functional test framework will skip annotated scenarios and log the skip reason.

## Running tests locally (examples)

Typecheck and lint:
```
bun run typecheck
npm run lint
```

Run a single behavioural auth scenario:
```
bun test tests/behavioural/auth-matrix.test.ts -t "React + SQLite + AbsoluteAuth"
```

Run cloud functional tests for Neon (requires `NEON_DATABASE_URL` in env):
```
NEON_DATABASE_URL=... bun test tests/functional/cloud.test.ts -t "neon + postgresql + react"
```

Run the full functional matrix (dry-run first):
```
bun run scripts/functional-tests/matrix.ts # generates test-matrix.json
bun run test:cli --dry-run
```

## Environment variable behavior
- **Functional tests**: Use matrix-level `requiredEnv` metadata to annotate which scenarios need cloud credentials. If env vars are missing, the test runner skips the scenario early with a logged message. This allows CI to run without credentials while developers can opt-in by setting vars.
- **Behavioural tests**: Use runtime guards at the start of each scenario (e.g., `resolveScenario()`) to check for required env vars. If missing, the test is skipped. These tests expect simplified env var names:
  - `NEON_DATABASE_URL` (not prefixed)
  - `TURSO_DB_URL` (not prefixed)
- **Setting credentials**: Export cloud database URLs before running tests:
  ```bash
  export NEON_DATABASE_URL="postgresql://user:pass@host/db"
  export TURSO_DB_URL="libsql://your-db.turso.io"
  bun test tests/behavioural/cloud-matrix.test.ts
  ```

## Interpreting skips
- Each skipped scenario includes a `skipReason` explaining why it was not executed.
- Common reasons:
  - "AbsoluteAuth is not supported with MongoDB"
  - "PlanetScale cloud flows are not exercised by CI (skipped)"
  - "missing env vars: NEON_DATABASE_URL"

## Behavioural auth endpoints to validate
- `GET /auth/providers` — returns 200 and a JSON array of provider names.
- `POST /auth/session` — should return 401 or 400 when unauthenticated, not 404.
- `GET /auth/authorize/:provider` and `GET /auth/callback/:provider` routes are generated by the scaffold and should be reachable (404 indicates generation ordering regressions).

## Reports & artifacts
- Test runner writes logs under `reports/` (create if missing). Use `reports/final-summary.json` to collect pass/skip/fail counts.

## Cleanup
- Use `npm run test:clean` or `bash scripts/clean-tests.sh --confirm` to safely remove generated `test-*` directories and `.test-dependency-cache`.

## Troubleshooting
- If servers fail to start due to port conflicts, kill lingering processes that bind to port 3000.
- If an expected provider is missing from `/auth/providers`, verify `src/generators/project/generateUseBlock.ts` still injects the providers endpoint and that `.use(absoluteAuth(...))` appears before static handlers.

---
End of guide.
